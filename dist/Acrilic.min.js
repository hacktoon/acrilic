/*! Acrilic 18-11-2015 */
var AC=function(){"use strict";return{ESC_KEY:27,TILESIZE:64,init:function(){}}}();AC.Dialog=function(){"use strict";var a=function(a,b){for(var c="",d=0;d<b.length;d++){var e=b[d],f="btn-"+e.title.replace(/\s+/g,"-").toLowerCase();c+='<button id="'+f+'">'+e.title+"</button>",a.on("click","#"+f,e.action)}return c};return{close:function(){$("#dialog-overlay").remove()},open:function(b,c,d){var e=this,f=$($("#tpl-dialog-overlay").html()),g=f.find("#dialog-content"),h=f.find("#dialog-button-panel");f.find(".btn-close").on("click",function(){e.close()}),f.find("#dialog-titlebar .title").html(b),g.html(c),h.html(a(f,d)),f.appendTo("body").show()},confirm:function(a,b){this.open("","<p>"+a+"</p>",[{title:"OK",action:function(){b()}},{title:"Cancel",action:function(){self.closeDialog()}}])}}}(),AC.editor=function(){"use strict";var a,b,c=[],d=0,e=!1,f={x:0,y:0};return{setTile:function(){var a=f.x,b=f.y,e=AC.tileCodeSelected.x,g=AC.tileCodeSelected.y,h=AC.tileSize,i=AC.tileset.sourceImage;AC.tileMap[b][a]!=AC.tileCodeSelected.code&&(AC.tileMap[b][a]=AC.tileCodeSelected.code,c[d].drawImage(i,e*h,g*h,h,h,a*h,b*h,h,h))},addLayer:function(b,d){var e=AC.graphics.createCanvas(b,d);a.append(e.canvas),c.push(e)},setCurrentLayer:function(a){c[a]&&(d=a)},init:function(c){var d=this,g=AC.mapWidth,h=AC.mapHeight;this.$el=$(c);var i=AC.tileSize;a=$("<div/>").attr("id","edit_area").css("width",g).css("height",h),this.$el.append(a),this.addLayer(g,h);var j=$("<div/>").attr("id","selection_cursor").css("width",i).css("height",i);a.append(j),a.on("mousemove",function(b){var c=a.offset().left,g=a.offset().top,h=a.scrollLeft()+$(document).scrollLeft(),k=a.scrollTop()+$(document).scrollTop(),l=b.clientX-c+h,m=b.clientY-g+k;l=0>l?0:l,m=0>m?0:m,f.x=parseInt(l/i),f.y=parseInt(m/i),j.css("left",f.x*i),j.css("top",f.y*i),e&&d.setTile()}),a.on("mousedown",function(a){a.preventDefault(),b.action(),e=!0}),$(document).on("mouseup",function(){e=!1})}}}(),AC.Graphics=function(){var a={draw:function(a,b,c){var d=this.width,e=this.height;this.ctx.drawImage(a,b,c,d,e,0,0,d,e)}};return{loadImage:function(a,b){var c=new Image;c.onload=function(){b(c,c.width,c.height)},c.src=a},createCanvas:function(b,c){var d=$.extend(!0,{},a),e=$("<canvas/>").attr("width",b).attr("height",c);return d.width=b,d.height=c,d.ctx=e.get(0).getContext("2d"),d.elem=e,d}}}(),AC.Interface=function(){"use strict";return{createDialogHandler:function(a){var b=this,c=a||{},d=$(c.templateSelector).html();$(c.btnSelector).on("click",function(){b.Dialog.open(c.title,$(d),c.buttonSet),c.initialize&&"function"==typeof c.initialize&&c.initialize()}),$(document).on("keydown",function(a){a.which==AC.ESC_KEY&&b.Dialog.close()})},createSwitchModeHandler:function(a,b){var c="active",d=$(a);d.on("click",function(a){d.removeClass(c);var e=$(this),f=e.attr("id");b[f];e.addClass(c)}),d.first().trigger("click")},createTilesetPalette:function(a,b){var c,d=this,e=AC.TILESIZE,f=$(a),g="menu-tile-selected";this.Graphics.loadImage(b.srcImage,function(a,b,h){for(var i=Math.floor(b/e),j=Math.floor(h/e),k=0;j>k;k++)for(var l=0;i>l;l++){var m=d.Graphics.createCanvas(e,e);m.draw(a,l*e,k*e),m.elem.addClass("menu-tile").data("tilecode",0),f.append(m.elem)}f.on("click",".menu-tile",function(){var a=$(this);c&&c.removeClass(g),a.addClass(g),c=a}).find(".menu-tile:first").trigger("click")})},build:function(a){var b=this;this.Graphics=a.graphics,this.Dialog=a.dialog,this.createDialogHandler({title:"New map",btnSelector:"#btn-file-new",templateSelector:"#tpl-dialog-file-new",buttonSet:[{title:"OK",action:function(){alert("OK")}},{title:"Cancel",action:function(){b.Dialog.close()}}]}),this.createDialogHandler({title:"Import",btnSelector:"#btn-file-import",templateSelector:"#tpl-dialog-file-import",buttonSet:[{title:"Import",action:function(){$("#field-file-import-output").val()}},{title:"Cancel",action:function(){b.Dialog.close()}}]}),this.createDialogHandler({title:"Export",btnSelector:"#btn-file-export",templateSelector:"#tpl-dialog-file-export",buttonSet:[{title:"Close",action:function(){b.Dialog.close()}}],initialize:function(){var a=JSON.stringify({a:2});$("#field-file-export-output").val(a)}}),this.createSwitchModeHandler(".btn-tool",{"btn-tool-pen":"pen","btn-tool-fill":"fill","btn-tool-eraser":"eraser"}),this.createSwitchModeHandler(".btn-layer",{"btn-layer-bg":"bg","btn-layer-fg":"fg","btn-layer-event":"event"}),this.createTilesetPalette("#tileset-panel",{srcImage:"tilesets/ground-layer.png"}),$("#map-panel").css("left",$("#tileset-panel-wrapper").width())}}}(),AC.Maps=function(){return{}}(),function(){"use strict";window.log=console.log.bind(console),AC.init(),AC.Interface.build({graphics:AC.Graphics,dialog:AC.Dialog})}();